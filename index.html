<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galería de Imágenes Cerro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            margin: 0;
            padding: 10px;
        }

        header {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .last-update {
            text-align: center;
            font-size: 10px;
            color: #7f8c8d;
            margin-bottom: 15px;
            font-style: italic;
        }

        .date-filters {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .date-filters label {
            font-weight: bold;
            color: #555;
            font-size: 0.9em;
        }

        .date-filters input[type="date"],
        .date-filters select {
            padding: 8px 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: white;
        }

        .date-filters button {
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .date-filters button:hover {
            background-color: #2980b9;
        }

        .loading {
            text-align: center;
            padding: 30px;
            font-size: 1.1em;
            color: #666;
            display: none;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 300px));
            gap: 8px;
            margin-bottom: 20px;
        }

        .image-container {
            position: relative;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .image-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .image-container img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .image-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            color: white;
            padding: 10px;
            transform: translateY(100%);
            transition: transform 0.3s;
            font-size: 0.8em;
        }

        .image-container:hover .image-overlay {
            transform: translateY(0);
        }

        .image-details div {
            margin-bottom: 3px;
        }

        .favorite-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .favorite-btn:hover {
            background: rgba(0, 0, 0, 0.7);
            transform: scale(1.1);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #paginationTop {
            margin-top: 0;
            margin-bottom: 20px;
        }

        .pagination button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .pagination button:not(:disabled) {
            background-color: #3498db;
            color: white;
        }

        .pagination button:not(:disabled):hover {
            background-color: #2980b9;
        }

        .pagination button:disabled {
            background-color: #bdc3c7;
            color: #7f8c8d;
            cursor: not-allowed;
        }

        #pageInfo {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            position: relative;
            margin: auto;
            padding: 15px;
            width: 95%;
            max-width: 900px;
            top: 50%;
            transform: translateY(-50%);
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            position: absolute;
            top: 5px;
            right: 15px;
            z-index: 1001;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .watermark-link-btn {
            background-color: #e67e22;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            margin-right: 10px;
        }

        .watermark-link-btn:hover {
            background-color: #d35400;
        }

        .download-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .download-btn:hover {
            background-color: #229954;
        }

        .close {
            color: #aaa;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 5px;
        }

        .close:hover {
            color: #333;
        }

        #modalImage {
            width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .image-info {
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            font-size: 0.9em;
        }

        .image-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .image-info div {
            margin-bottom: 6px;
            padding: 3px 0;
        }

        .no-images,
        .error {
            text-align: center;
            padding: 40px 15px;
            font-size: 1em;
            color: #666;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .error {
            color: #e74c3c;
            border-left: 4px solid #e74c3c;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }

            header h1 {
                font-size: 1.5em;
                margin-bottom: 10px;
            }

            .date-filters {
                flex-direction: column;
                gap: 8px;
            }

            .date-filters input[type="date"],
            .date-filters select,
            .date-filters button {
                width: 100%;
                max-width: 250px;
            }

            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(180px, 250px));
                gap: 5px;
            }

            .image-container img {
                height: 150px;
            }

            .pagination {
                flex-direction: column;
                gap: 8px;
            }

            .modal-content {
                width: 98%;
                padding: 10px;
            }

            .image-info {
                padding: 8px;
                font-size: 0.85em;
            }
        }

        @media (max-width: 480px) {
            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(150px, 200px));
            }

            .image-container img {
                height: 120px;
            }
        }

        /* Ensure images maintain aspect ratio within size constraints */
        @media (min-width: 1200px) {
            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(200px, 300px));
            }

            .image-container img {
                height: 250px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Galería de Imágenes Cerro</h1>
            <div class="last-update">Última actualización de la web: <span id="lastUpdateDate"></span></div>
            <div class="date-filters">
                <label for="dateFrom">Desde:</label>
                <input type="date" id="dateFrom" value="">
                <label for="dateTo">Hasta:</label>
                <input type="date" id="dateTo" value="">
                <label for="photographer">Fotógrafo:</label>
                <select id="photographer" onchange="loadImages(1)">
                    <option value="">Todos los fotógrafos</option>
                </select>
                <label for="tags">Etiquetas:</label>
                <select id="tags" onchange="loadImages(1)">
                    <option value="">Todas las etiquetas</option>
                </select>
                <label for="showFavorites">
                    <input type="checkbox" id="showFavorites" onchange="loadImages(1)"> Solo favoritos
                </label>
                <!-- Color filter hidden for now
                <label for="colorFilter">Color dominante:</label>
                <select id="colorFilter" onchange="filterByColor()" style="display: none;">
                    <option value="">Todos los colores</option>
                    <option value="rojo">🔴 Rojo</option>
                    <option value="naranja">🟠 Naranja</option>
                    <option value="amarillo">🟡 Amarillo</option>
                    <option value="verde">🟢 Verde</option>
                    <option value="cyan">🔵 Cyan</option>
                    <option value="azul">🔵 Azul</option>
                    <option value="morado">🟣 Morado</option>
                    <option value="negro">⚫ Negro</option>
                    <option value="blanco">⚪ Blanco</option>
                    <option value="gris">🔘 Gris</option>
                </select>
                -->
                <label for="perPage">Fotos por página:</label>
                <select id="perPage" onchange="changePerPage()">
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                    <option value="1000" selected>1000</option>
                    <option value="2000">2000</option>
                    <option value="5000">5000</option>
                </select>
                <button onclick="loadImages(1)">Filtrar</button>
            </div>
        </header>

        <!-- Paginado superior -->
        <div class="pagination" id="paginationTop">
            <button id="prevBtnTop" onclick="previousPage()" disabled>Anterior</button>
            <span id="pageInfoTop">Página 1</span>
            <button id="nextBtnTop" onclick="nextPage()">Siguiente</button>
        </div>

        <div class="loading" id="loading">Cargando imágenes...</div>

        <div class="gallery" id="gallery"></div>

        <div class="pagination" id="pagination">
            <button id="prevBtn" onclick="previousPage()" disabled>Anterior</button>
            <span id="pageInfo">Página 1</span>
            <button id="nextBtn" onclick="nextPage()">Siguiente</button>
        </div>
    </div>

    <div class="modal" id="modal" onclick="closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <button class="watermark-link-btn" id="watermarkLinkBtn" onclick="openWatermarkRemover(event)">Remover
                    marca de agua</button>
                <button class="download-btn" id="downloadBtn" onclick="downloadImage(event)">Descargar</button>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <img id="modalImage" src="" alt="">
            <div class="image-info" id="imageInfo"></div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let perPage = 1000;
        let currentImages = [];
        let photographers = [];
        let availableTags = [];
        let favorites = JSON.parse(localStorage.getItem('cerro-favorites') || '[]');
        let imageColors = new Map(); // Cache for dominant colors
        let tagsLoaded = false; // Flag to prevent reloading tags

        // URL Parameters functionality
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                page: parseInt(urlParams.get('page')) || 1,
                perPage: parseInt(urlParams.get('perPage')) || 1000,
                dateFrom: urlParams.get('dateFrom') || '',
                dateTo: urlParams.get('dateTo') || '',
                photographer: urlParams.get('photographer') || '',
                tags: urlParams.get('tags') || '',
                favorites: urlParams.get('favorites') === 'true'
            };
        }

        function decodeUrlTag(encodedTag) {
            if (!encodedTag) return '';

            let decoded = encodedTag;
            let attempts = 0;
            const maxAttempts = 3;

            console.log('Decoding tag:', encodedTag);

            while (decoded.includes('%') && attempts < maxAttempts) {
                try {
                    const previous = decoded;
                    decoded = decodeURIComponent(decoded);
                    console.log(`Decode attempt ${attempts + 1}: "${previous}" -> "${decoded}"`);
                    attempts++;
                } catch (e) {
                    console.log('Decode error:', e.message);
                    break;
                }
            }

            return decoded.trim();
        }

        function updateUrlParams() {
            const urlParams = new URLSearchParams();

            // Add current filter values
            if (currentPage > 1) urlParams.set('page', currentPage);
            if (perPage !== 1000) urlParams.set('perPage', perPage);

            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const photographer = document.getElementById('photographer').value;
            const tags = document.getElementById('tags').value;
            const favorites = document.getElementById('showFavorites').checked;

            if (dateFrom) urlParams.set('dateFrom', dateFrom);
            if (dateTo) urlParams.set('dateTo', dateTo);
            if (photographer) urlParams.set('photographer', photographer);
            if (tags) {
                // Encode tags properly for URL
                urlParams.set('tags', encodeURIComponent(tags.trim()));
            }
            if (favorites) urlParams.set('favorites', 'true');

            // Update URL without reloading page
            const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
            window.history.replaceState({}, '', newUrl);
        }

        function applyUrlParams() {
            const params = getUrlParams();

            // Apply parameters to form controls
            if (params.page) currentPage = params.page;
            if (params.perPage) {
                perPage = params.perPage;
                document.getElementById('perPage').value = perPage;
            }
            if (params.dateFrom) document.getElementById('dateFrom').value = params.dateFrom;
            if (params.dateTo) document.getElementById('dateTo').value = params.dateTo;
            if (params.photographer) document.getElementById('photographer').value = params.photographer;
            if (params.tags) {
                const decodedTag = decodeUrlTag(params.tags);
                document.getElementById('tags').value = decodedTag;
                console.log('Applied tag from URL:', decodedTag, '(original:', params.tags, ')');
            }
            if (params.favorites) document.getElementById('showFavorites').checked = params.favorites;
        }

        function changePerPage() {
            perPage = parseInt(document.getElementById('perPage').value);
            loadImages(1);
            scrollToTop();
        }

        async function fetchPhotographers() {
            try {
                const response = await fetch('https://api1.foti.ar/users/get-photographers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ term: "" })
                });

                if (!response.ok) {
                    throw new Error(`Error: ${response.status}`);
                }

                const data = await response.json();

                if (data.ok && data.photographers) {
                    photographers = data.photographers;
                    populatePhotographerDropdown();
                }
            } catch (error) {
                console.error('Error fetching photographers:', error);
            }
        }

        function populatePhotographerDropdown() {
            const photographerSelect = document.getElementById('photographer');
            photographerSelect.innerHTML = '<option value="">Todos los fotógrafos</option>';

            photographers.forEach(photographer => {
                const option = document.createElement('option');
                option.value = photographer.email;
                option.textContent = photographer.name || photographer.email;
                photographerSelect.appendChild(option);
            });
        }

        function extractAndPopulateTags(images) {
            console.log('Extracting tags from', images.length, 'images');
            const allTags = new Set();

            images.forEach(image => {
                if (image.tags && Array.isArray(image.tags)) {
                    image.tags.forEach(tag => {
                        if (tag && tag.trim()) {
                            allTags.add(tag.trim());
                        }
                    });
                }
            });

            availableTags = Array.from(allTags).sort();
            console.log('Extracted tags:', availableTags);
            populateTagsDropdown();
        }

        function populateTagsDropdown() {
            const tagSelect = document.getElementById('tags');
            const currentValue = tagSelect.value;

            tagSelect.innerHTML = '<option value="">Todas las etiquetas</option>';

            availableTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                tagSelect.appendChild(option);
            });

            // Restore previous selection if it still exists
            if (currentValue && availableTags.includes(currentValue)) {
                tagSelect.value = currentValue;
            }
        }

        function populateTagsFromApi(tagsArray) {
            console.log('Populating tags from API:', tagsArray);
            const tagSelect = document.getElementById('tags');
            const currentValue = tagSelect.value;

            tagSelect.innerHTML = '<option value="">Todas las etiquetas</option>';

            // Sort tags by count (descending) then by name
            const sortedTags = tagsArray.sort((a, b) => {
                if (b.count !== a.count) {
                    return b.count - a.count;
                }
                return a.tag.localeCompare(b.tag);
            });

            sortedTags.forEach(tagObj => {
                const option = document.createElement('option');
                option.value = tagObj.tag.trim();
                option.textContent = `${tagObj.tag.trim()} (${tagObj.count})`;
                tagSelect.appendChild(option);
            });

            // Restore previous selection if it still exists
            if (currentValue) {
                // Try exact match first
                let foundTag = sortedTags.find(tagObj => tagObj.tag.trim() === currentValue);

                // If not found, try case-insensitive match
                if (!foundTag) {
                    foundTag = sortedTags.find(tagObj =>
                        tagObj.tag.trim().toLowerCase() === currentValue.toLowerCase()
                    );
                }

                // If still not found, try partial match (for URL parameters)
                if (!foundTag) {
                    foundTag = sortedTags.find(tagObj =>
                        tagObj.tag.trim().toLowerCase().includes(currentValue.toLowerCase()) ||
                        currentValue.toLowerCase().includes(tagObj.tag.trim().toLowerCase())
                    );
                }

                if (foundTag) {
                    tagSelect.value = foundTag.tag.trim();
                    console.log('Restored tag selection:', foundTag.tag.trim());
                } else {
                    console.log('Could not find matching tag for:', currentValue);
                    console.log('Available tags:', sortedTags.map(t => t.tag.trim()));
                }
            }

            availableTags = sortedTags.map(tagObj => tagObj.tag.trim());
            console.log('Available tags updated:', availableTags);
        }

        async function loadAllTags() {
            if (tagsLoaded) {
                console.log('Tags already loaded, skipping...');
                return;
            }

            console.log('Loading all tags...');
            try {
                const response = await fetch('https://api1.foti.ar/images/search/client', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filters: {
                            date: null, // No date filter to get all tags
                            photographer: null,
                            order: {
                                by: "creationDate",
                                order: "1"
                            },
                            tags: [],
                            favorites: {
                                active: false,
                                images: []
                            },
                            purchases: {
                                active: false,
                                images: []
                            }
                        },
                        pagination: {
                            perPage: 1, // Only need 1 image to get the tags list
                            actualPage: 1
                        },
                        purchased: []
                    })
                });

                console.log('Tags API response status:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Tags API data:', { ok: data.ok, imageCount: data.images?.length, tagsCount: data.tags?.length });

                    if (data.ok && data.tags && Array.isArray(data.tags)) {
                        // Use the tags array from the API response
                        console.log('Using API tags:', data.tags);
                        populateTagsFromApi(data.tags);
                        tagsLoaded = true; // Mark as loaded
                    } else if (data.ok && data.images) {
                        // Fallback to extracting from images
                        console.log('Fallback: extracting tags from images');
                        extractAndPopulateTags(data.images);
                        tagsLoaded = true; // Mark as loaded
                    }
                } else {
                    console.error('Error response:', await response.text());
                }
            } catch (error) {
                console.error('Error loading tags:', error);
            }
        }

        // Favorites functionality
        function toggleFavorite(imageId, event) {
            event.stopPropagation();

            const index = favorites.indexOf(imageId);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(imageId);
            }

            localStorage.setItem('cerro-favorites', JSON.stringify(favorites));

            // Update the heart icon
            const heartIcon = event.target;
            heartIcon.classList.toggle('favorited', favorites.includes(imageId));
            heartIcon.innerHTML = favorites.includes(imageId) ? '❤️' : '🤍';
        }

        function isFavorite(imageId) {
            return favorites.includes(imageId);
        }

        // Color analysis functions
        function rgbToHsl(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;

            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }

            return [h * 360, s * 100, l * 100];
        }

        function getColorCategory(r, g, b) {
            const [h, s, l] = rgbToHsl(r, g, b);

            // Very dark or very light
            if (l < 15) return 'negro';
            if (l > 85) return 'blanco';

            // Low saturation = gray
            if (s < 20) return 'gris';

            // Color categories based on hue
            if (h >= 0 && h < 15) return 'rojo';
            if (h >= 15 && h < 45) return 'naranja';
            if (h >= 45 && h < 75) return 'amarillo';
            if (h >= 75 && h < 150) return 'verde';
            if (h >= 150 && h < 210) return 'cyan';
            if (h >= 210 && h < 270) return 'azul';
            if (h >= 270 && h < 330) return 'morado';
            if (h >= 330) return 'rojo';

            return 'otro';
        }

        // Simple color assignment for demo purposes (since CORS blocks real analysis)
        function assignDemoColor(imageId) {
            // Simple pattern based on image ID to simulate color analysis
            const hash = imageId.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);

            const colors = ['rojo', 'verde', 'azul', 'amarillo', 'naranja', 'morado', 'gris', 'negro', 'blanco'];
            const colorIndex = Math.abs(hash) % colors.length;
            return colors[colorIndex];
        }

        function extractDominantColor(img, imageId) {
            return new Promise((resolve) => {
                console.log('Analyzing color for:', imageId);

                // For demo purposes, assign a consistent color based on image ID
                const demoColor = assignDemoColor(imageId);
                console.log(`Demo color assigned for ${imageId}: ${demoColor}`);

                imageColors.set(imageId, demoColor);
                resolve(demoColor);
            });
        }

        async function fetchImages(page = 1) {
            const dateFrom = document.getElementById('dateFrom').value + 'T00:00:00.000Z';
            const dateTo = document.getElementById('dateTo').value + 'T23:59:59.999Z';
            const selectedPhotographer = document.getElementById('photographer').value;
            const selectedTag = document.getElementById('tags').value;
            const showFavoritesOnly = document.getElementById('showFavorites').checked;

            const tags = selectedTag ? [{ tag: selectedTag }] : [];

            // If filtering by favorites only but no favorites exist, show empty gallery
            if (showFavoritesOnly && favorites.length === 0) {
                const gallery = document.getElementById('gallery');
                gallery.innerHTML = '<div class="no-images">No tienes imágenes marcadas como favoritos</div>';
                updatePagination();
                return;
            }

            console.log('Filtering with:', {
                dateFrom,
                dateTo,
                photographer: selectedPhotographer,
                selectedTag: selectedTag,
                tags: tags,
                favoritesOnly: showFavoritesOnly,
                favoritesCount: favorites.length
            });

            const requestBody = {
                filters: {
                    date: showFavoritesOnly ? null : {
                        from: dateFrom,
                        to: dateTo
                    },
                    photographer: selectedPhotographer || null,
                    order: {
                        by: "creationDate",
                        order: "1"
                    },
                    tags: tags,
                    favorites: {
                        active: showFavoritesOnly,
                        images: showFavoritesOnly ? favorites : []
                    },
                    purchases: {
                        active: false,
                        images: []
                    }
                },
                pagination: {
                    perPage: perPage,
                    actualPage: page
                },
                purchased: []
            };

            try {
                showLoading(true);
                const response = await fetch('https://api1.foti.ar/images/search/client', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`Error: ${response.status}`);
                }

                const data = await response.json();

                console.log('API Response:', {
                    ok: data.ok,
                    imageCount: data.images ? data.images.length : 0,
                    pagination: data.pagination,
                    tagsCount: data.tags ? data.tags.length : 0
                });

                if (data.ok && data.images) {
                    currentImages = data.images;
                    currentPage = page;

                    if (data.pagination && data.pagination.total) {
                        totalPages = Math.ceil(data.pagination.total / perPage);
                    } else {
                        totalPages = data.images.length === perPage ? page + 1 : page;
                    }

                    // Don't update tags from fetchImages response to keep them stable
                    // Tags are loaded once at startup via loadAllTags()

                    displayImages(data.images);
                    updatePagination();
                    updateUrlParams();
                } else {
                    console.error('Error en la respuesta:', data);
                    showError('Error al cargar las imágenes');
                }
            } catch (error) {
                console.error('Error fetching images:', error);
                showError('Error de conexión: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function filterByColor() {
            const selectedColor = document.getElementById('colorFilter').value;
            const gallery = document.getElementById('gallery');
            const allContainers = gallery.querySelectorAll('.image-container');

            console.log('=== COLOR FILTER DEBUG ===');
            console.log('Selected color:', selectedColor);
            console.log('Found containers:', allContainers.length);

            // Remove any existing no-results message first
            const existingNoResults = gallery.querySelector('.no-color-results');
            if (existingNoResults) existingNoResults.remove();

            if (!selectedColor) {
                // Show all images
                allContainers.forEach(container => {
                    container.style.display = 'block';
                });
                console.log('No color selected, showing all images');
                return;
            }

            // Show loading indicator
            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'color-loading';
            loadingIndicator.innerHTML = '🎨 Analizando colores...';
            loadingIndicator.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 20px;
                border-radius: 10px;
                z-index: 1000;
                font-size: 16px;
            `;
            document.body.appendChild(loadingIndicator);

            let visibleCount = 0;

            // Process each image container
            for (let i = 0; i < allContainers.length; i++) {
                const container = allContainers[i];
                const img = container.querySelector('img');
                const imageId = container.dataset.imageId;

                console.log(`Processing container ${i + 1}/${allContainers.length}, imageId:`, imageId);

                if (!imageId) {
                    console.log('No imageId found, skipping');
                    container.style.display = 'none';
                    continue;
                }

                // Get or analyze color
                let dominantColor = imageColors.get(imageId);

                if (!dominantColor) {
                    console.log('Color not cached, analyzing...');
                    dominantColor = await extractDominantColor(img, imageId);
                } else {
                    console.log('Using cached color:', dominantColor);
                }

                console.log(`Image ${imageId} -> ${dominantColor}, selected: ${selectedColor}, match: ${dominantColor === selectedColor}`);

                // Show/hide based on color match
                if (dominantColor === selectedColor) {
                    container.style.display = 'block';
                    visibleCount++;
                } else {
                    container.style.display = 'none';
                }
            }

            // Remove loading indicator
            const loading = document.getElementById('color-loading');
            if (loading) document.body.removeChild(loading);

            console.log(`Color filtering complete. Visible: ${visibleCount}/${allContainers.length}`);

            // Show message if no images match
            if (visibleCount === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'no-color-results';
                noResults.innerHTML = `No se encontraron imágenes con color dominante: ${selectedColor}`;
                noResults.style.cssText = `
                    text-align: center;
                    padding: 40px;
                    color: #666;
                    font-size: 16px;
                    grid-column: 1 / -1;
                `;
                gallery.appendChild(noResults);
                console.log('Added no results message');
            }
        }

        function displayImages(images) {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';

            if (images.length === 0) {
                gallery.innerHTML = '<div class="no-images">No se encontraron imágenes para las fechas seleccionadas</div>';
                return;
            }

            images.forEach((image, index) => {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'image-container';
                imageContainer.dataset.imageId = image._id;

                const img = document.createElement('img');
                img.src = image.copyFileName;
                img.alt = `Imagen ${index + 1}`;
                img.loading = 'lazy';
                img.onclick = () => openModal(image);

                // Favorite button
                const favoriteBtn = document.createElement('div');
                favoriteBtn.className = 'favorite-btn';
                favoriteBtn.innerHTML = isFavorite(image._id) ? '❤️' : '🤍';
                favoriteBtn.onclick = (e) => toggleFavorite(image._id, e);

                const imageInfo = document.createElement('div');
                imageInfo.className = 'image-overlay';

                const date = new Date(image.creationDate).toLocaleDateString('es-ES');
                const photographer = image.photographerData.name;
                const tags = image.tags.length > 0 ? image.tags.join(', ') : 'Sin etiquetas';

                imageInfo.innerHTML = `
                    <div class="image-details">
                        <div><strong>Fecha:</strong> ${date}</div>
                        <div><strong>Fotógrafo:</strong> ${photographer}</div>
                        <div><strong>Etiquetas:</strong> ${tags}</div>
                    </div>
                `;

                imageContainer.appendChild(img);
                imageContainer.appendChild(favoriteBtn);
                imageContainer.appendChild(imageInfo);
                gallery.appendChild(imageContainer);

                // Color analysis disabled for now
                /*
                setTimeout(() => {
                    if (!imageColors.has(image._id)) {
                        extractDominantColor(img, image._id).then(() => {
                            console.log(`Pre-analyzed color for ${image._id}:`, imageColors.get(image._id));
                        });
                    }
                }, 100);
                */
            });

            // Reset color filter when new images are loaded (disabled for now)
            // document.getElementById('colorFilter').value = '';
        }

        function openModal(image) {
            const modal = document.getElementById('modal');
            const modalImage = document.getElementById('modalImage');
            const imageInfo = document.getElementById('imageInfo');

            // Mostrar imagen con marca de agua
            modalImage.src = image.copyFileName;

            const date = new Date(image.creationDate).toLocaleDateString('es-ES');
            const exif = image.exifData;

            imageInfo.innerHTML = `
                <h3>Detalles de la imagen</h3>
                <div><strong>Fecha de creación:</strong> ${date}</div>
                <div><strong>Fotógrafo:</strong> ${image.photographerData.name}</div>
                <div><strong>Etiquetas:</strong> ${image.tags.join(', ') || 'Sin etiquetas'}</div>
                ${exif ? `
                    <div><strong>Cámara:</strong> ${exif.Make?.replace(/"/g, '')} ${exif.Model?.replace(/"/g, '')}</div>
                    <div><strong>Dimensiones:</strong> ${exif.Dimensions?.width} x ${exif.Dimensions?.height}</div>
                    <div><strong>ISO:</strong> ${exif.ISO}</div>
                    <div><strong>Apertura:</strong> f/${exif.FNumber}</div>
                    <div><strong>Velocidad:</strong> 1/${Math.round(1 / parseFloat(exif.ExposureTime))}s</div>
                    <div><strong>Distancia focal:</strong> ${exif.FocalLength}mm</div>
                ` : ''}
            `;

            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function openWatermarkRemover(event) {
            event.stopPropagation();

            const modalImage = document.getElementById('modalImage');
            const imageUrl = modalImage.src;

            // Copiar URL al portapapeles
            navigator.clipboard.writeText(imageUrl).then(() => {
                // Mostrar mensaje de confirmación
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '¡URL copiada!';
                btn.style.backgroundColor = '#27ae60';

                // Restaurar botón después de 2 segundos
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '#e67e22';
                }, 2000);

                // Abrir WatermarkRemover.io en nueva pestaña
                window.open('https://www.watermarkremover.io/', '_blank');
            }).catch(err => {
                console.error('Error copiando al portapapeles:', err);
                // Fallback: abrir directamente con la URL como parámetro
                const watermarkUrl = `https://www.watermarkremover.io/?url=${encodeURIComponent(imageUrl)}`;
                window.open(watermarkUrl, '_blank');
            });
        }

        function downloadImage(event) {
            event.stopPropagation(); // Evitar que se cierre el modal
            const imageUrl = document.getElementById('modalImage').src;
            const imageName = imageUrl.split('/').pop() || 'imagen.jpg';

            // Crear un elemento 'a' temporal para descargar
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = imageName;
            link.target = '_blank';

            // Trigger de descarga
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function updatePagination() {
            // Actualizar paginado inferior
            document.getElementById('pageInfo').textContent = `Página ${currentPage} de ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;

            // Actualizar paginado superior
            document.getElementById('pageInfoTop').textContent = `Página ${currentPage} de ${totalPages}`;
            document.getElementById('prevBtnTop').disabled = currentPage <= 1;
            document.getElementById('nextBtnTop').disabled = currentPage >= totalPages;
        }

        function previousPage() {
            if (currentPage > 1) {
                loadImages(currentPage - 1);
                scrollToTop();
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                loadImages(currentPage + 1);
                scrollToTop();
            }
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function loadImages(page) {
            fetchImages(page);
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = `<div class="error">${message}</div>`;
        }

        function setLastUpdateDate() {
            // Obtener fecha del último commit desde GitHub API
            fetch('https://api.github.com/repos/braianj/cerro/commits?per_page=1')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al obtener datos de GitHub');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.length > 0) {
                        const commitDate = new Date(data[0].commit.committer.date);
                        const options = {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        };
                        const formattedDate = commitDate.toLocaleDateString('es-ES', options);
                        document.getElementById('lastUpdateDate').textContent = formattedDate;
                    } else {
                        // Fallback si no hay commits
                        document.getElementById('lastUpdateDate').textContent = 'No disponible';
                    }
                })
                .catch(error => {
                    console.error('Error obteniendo fecha del commit:', error);
                    // Fallback en caso de error
                    document.getElementById('lastUpdateDate').textContent = 'Error al cargar';
                });
        }

        // Cargar imágenes al iniciar la página
        document.addEventListener('DOMContentLoaded', function () {
            // Establecer fecha de última actualización
            setLastUpdateDate();

            // Aplicar parámetros URL primero
            applyUrlParams();

            // Configurar fechas por defecto solo si no hay parámetros URL
            const params = getUrlParams();
            if (!params.dateFrom || !params.dateTo) {
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                const formatDate = (date) => {
                    return date.toISOString().split('T')[0];
                };

                if (!params.dateFrom) {
                    document.getElementById('dateFrom').value = formatDate(yesterday);
                }
                if (!params.dateTo) {
                    document.getElementById('dateTo').value = formatDate(today);
                }
            }

            // Establecer perPage si no viene de URL
            if (!params.perPage) {
                document.getElementById('perPage').value = perPage;
            }

            fetchPhotographers();
            loadAllTags();
            loadImages(currentPage);
        });

        // Cerrar modal con Escape
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>

</html>